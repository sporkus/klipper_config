[gcode_macro M84]
description: Check for safe z before kiling motor to avoid probe crash
rename_existing: M84.1 
gcode:
    {% set th = printer.toolhead %}
    {% set safe_z = printer["gcode_macro _User_Variables"].safe_z|float %}
    {% set probe_attached = printer["gcode_macro _Probe_Variables"].probe_attached %}

    {% if probe_attached %}
        dock_probe_unlock
    {% endif %}

    {% if "z" in th.homed_axes %}
        {% if th.position.z|float < safe_z %}
            {action_respond_info("Moving toolhead to safe z={}".format(safe_z))}
            G90 
            G1 Z{safe_z}
            G0 X{th.axis_maximum.x/2} Y{th.axis_minimum.y + 1} F10000  ; park nozzle at front for balance 
        {% endif %}
    {% endif %}

    M84.1
    STATUS_BUSY

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
description: Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode:
    {% set V = printer["gcode_macro _User_Variables"].verbose %}

    {% if V %} { action_respond_info("QG Level") } {% endif %}
    _CheckProbe action=query
	G90
    {% if 'xyz' not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    Attach_Probe
    STATUS_LEVELING
    _QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
    G28 Z
    Dock_Probe
    STATUS_READY

[gcode_macro BED_MESH_CALIBRATE]
description: Perform Mesh Bed Leveling with klicky automount
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set toolhead = printer["toolhead"] %}
    {% set V = printer["gcode_macro _User_Variables"].verbose %}

    {% if not printer['quad_gantry_level'].applied %}
        QUAD_GANTRY_LEVEL
    {% endif %}

    {% if V %} M118 BED_MESH_CALIBRATE {params_str} {% endif %}
    STATUS_MESHING
    _CheckProbe action=query
    G90
    Attach_Probe
    {% if V %}
        M118 BED_MESH_CALIBRATE {% for k,v in params|dictsort %} {"{}={} ".format(k,v)} {% endfor %}
    {% endif %}
    _BED_MESH_CALIBRATE {% for k,v in params|dictsort %} {"{}={} ".format(k,v)} {% endfor %}
    Dock_Probe
    STATUS_READY
    
[gcode_macro CALIBRATE_Z]
rename_existing: BASE_CALIBRATE_Z
gcode:
    {% if not printer['quad_gantry_level'].applied %}
        QUAD_GANTRY_LEVEL
    {% endif %}
    STATUS_CALIBRATING_Z
    M117 Z-Calibration..
    SET_GCODE_OFFSET Z=0
    BASE_CALIBRATE_Z {% for p,v in params.items() %} {'{}={} '.format(p,v)} {% endfor %}
    M117
